{
    "lastRunStatus": 1,
    "lastRunTime": 1764754710979,
    "uniqueIdentifier": "07d2afbc-b4c2-4748-8533-8e6043aa2572",
    "id": 0,
    "jobDefinitionId": 0,
    "name": "Refresh Token Renewal Job",
    "integration": "MicrosoftGraphMailDelegated",
    "script": "from __future__ import annotations\n\nfrom typing import NoReturn\n\nfrom collections.abc import MutableMapping\n\nfrom TIPCommon.base.job import RefreshTokenRenewalJob, validate_param_csv_to_multi_value\n\nfrom constants import (\n    INTEGRATION_NAME,\n    TOKEN_RENEWAL_SCRIPT_NAME,\n)\nfrom AuthenticationManager import (\n    generate_tokens,\n    get_authenticated_session,\n    SessionAuthenticationParameters,\n)\nfrom exceptions import InvalidParameterException\n\n\nclass RefreshTokenJob(RefreshTokenRenewalJob):\n    \"\"\"Refresh Token Renewal Job to update refresh token periodically.\"\"\"\n\n    def __init__(self, script_name: str, integration_identifier: str) -> None:\n        super().__init__(script_name, integration_identifier)\n        self.error_msg = f\"{script_name} failed to run because \"\n\n    def _get_integration_envs(self) -> str:\n        return self.params.integration_environments\n\n    def _get_connector_names(self) -> str:\n        return self.params.connector_names\n\n    def _validate_params(self) -> None:\n        \"\"\"Validate the parameters values.\n\n        Raises:\n           InvalidParameterException: If both integration environments and connector\n                names are not provided.\n        \"\"\"\n        self.params.integration_environments = validate_param_csv_to_multi_value(\n            param_name=\"Integration Environments\",\n            param_csv_value=self.params.integration_environments,\n        )\n        self.params.connector_names = validate_param_csv_to_multi_value(\n            param_name=\"Connector Names\",\n            param_csv_value=self.params.connector_names,\n        )\n        if not self.params.integration_environments and not self.params.connector_names:\n            raise InvalidParameterException(\n                f\"{self.error_msg} both Integration Environments \"\n                \"and Connector Names parameters are not provided.\"\n            )\n\n    def _refresh_integration_token(\n        self,\n        instance_identifier: str,\n    ) -> None:\n        \"\"\"Refreshes the refresh token for a specific integration instance.\n\n        Args:\n            instance_identifier (str): The identifier of the integration instance.\n                e.g.: \"ce0027a2-2b53-4cce-ad08-430df6d002f3\"\n        \"\"\"\n        instance_settings = self._get_integration_configuration_params(\n            integration_instance_identifier=instance_identifier,\n        )\n        auth_params = self._build_manager_for_instance(\n            instance_identifier=instance_settings\n        )\n        auth_session = get_authenticated_session(auth_params)\n        tokens = generate_tokens(auth_session, auth_params)\n\n        self.soar_job.set_configuration_property(\n            integration_instance_identifier=instance_identifier,\n            property_name=\"Refresh Token\",\n            property_value=tokens.refresh_token,\n        )\n\n    def _refresh_connector_token(\n        self,\n        instance_identifier: str,\n    ) -> None:\n        \"\"\"Refreshes the refresh token for a specific connector instance.\n        Args:\n            instance_identifier (str): The identifier of the connector instance.\n                e.g.: \"Test_OauthConnector_75098aae-de81-44cc-a807-4843d5ae7ea5\"\n        \"\"\"\n        connector_settings = self._get_connector_configuration_params(\n            connector_identifier=instance_identifier,\n        )\n        auth_params = self._build_manager_for_instance(\n            instance_identifier=connector_settings\n        )\n        auth_session = get_authenticated_session(auth_params)\n        tokens = generate_tokens(auth_session, auth_params)\n        self.soar_job.set_connector_parameter(\n            connector_instance_identifier=instance_identifier,\n            parameter_name=\"Refresh Token\",\n            parameter_value=tokens.refresh_token,\n        )\n\n    def _build_manager_for_instance(\n        self,\n        instance_identifier: MutableMapping[str, str],\n    ) -> SessionAuthenticationParameters:\n        \"\"\"\n        Builds SessionAuthenticationParameters from instance settings.\n\n        Args:\n            instance_settings(dict(str, str)):  A dictionary containing the instance\n            settings.\n\n        Returns:\n            SessionAuthenticationParameters: A SessionAuthenticationParameters object.\n        \"\"\"\n        return SessionAuthenticationParameters(\n            azure_ad_endpoint=instance_identifier.get(\"Microsoft Entra ID Endpoint\"),\n            client_id=instance_identifier.get(\"Client ID\"),\n            client_secret=instance_identifier.get(\"Client Secret Value\"),\n            tenant=instance_identifier.get(\"Microsoft Entra ID Directory ID\"),\n            refresh_token=instance_identifier.get(\"Refresh Token\"),\n            verify_ssl=instance_identifier.get(\"Verify SSL\").lower() == \"true\",\n        )\n\n\ndef main() -> NoReturn:\n    RefreshTokenJob(TOKEN_RENEWAL_SCRIPT_NAME, INTEGRATION_NAME).start()\n\n\nif __name__ == \"__main__\":\n    main()\n",
    "creator": "admin",
    "description": "Token renewal job should be used to periodically update the refresh token configured for the integration. By default, the refresh token expires every 90 days, making integration unusable upon expiration. It is recommended to run this job every 7 or 14 days to make sure that refresh token will be up to date.",
    "isEnabled": false,
    "isCustom": false,
    "version": 1,
    "parameters": [
        {
            "id": 82,
            "isMandatory": false,
            "name": "Integration Environments",
            "type": 2,
            "value": "Default Environment"
        },
        {
            "id": 83,
            "isMandatory": false,
            "name": "Connector Names",
            "type": 2,
            "value": "Microsoft Graph Mail Delegated Connector"
        }
    ],
    "runIntervalInSeconds": 3600,
    "creationTime": "2025-12-03T09:38:27.001Z",
    "lastModificationTime": "2025-12-03T09:38:30.987Z",
    "isSystemJob": false,
    "jobDefinitionName": "Refresh Token Renewal Job",
    "agentIdentifier": null,
    "advanced": false,
    "advancedConfig": null
}